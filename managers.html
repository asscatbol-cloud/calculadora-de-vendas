<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            height: 1.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="auth-section" class="container w-full max-w-md p-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Acesso de Gerência</h2>
        <div id="auth-message" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>
        <form id="auth-form" class="space-y-4">
            <div>
                <label for="auth-email" class="block text-sm font-medium text-gray-700">E-mail</label>
                <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <button type="submit" id="auth-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Entrar como Gerente
            </button>
        </form>
    </div>

    <div id="main-section" class="container hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
            <h1 id="main-title" class="text-2xl sm:text-3xl font-bold text-gray-800">Painel de Gerência</h1>
            <div class="flex space-x-2">
                <button id="dashboard-tab-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700">Painel</button>
                <button id="goals-tab-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg shadow-md hover:bg-gray-300">Metas</button>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700">Sair</button>
            </div>
        </div>
        
        <!-- Conteúdo do Painel -->
        <div id="dashboard-content">
            <div class="flex justify-between items-center mb-6">
                <p class="text-gray-500">Visão consolidada da performance da equipe.</p>
                <button id="view-products-btn" class="px-4 py-2 bg-teal-600 text-white font-medium rounded-lg shadow-md hover:bg-teal-700">Ver Vendas de Produtos</button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Cards de Vendas e Receita atualizados -->
                <div class="bg-purple-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-purple-700">Total de Vendas</p>
                    <div class="mt-2 space-y-1">
                        <p class="text-lg font-semibold text-purple-900">Mês Atual: <span id="total-sales-current">0</span></p>
                        <p class="text-md text-gray-600">Mês Anterior: <span id="total-sales-previous">0</span></p>
                    </div>
                </div>
                <div class="bg-pink-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-pink-700">Receita Total da Equipe</p>
                    <div class="mt-2 space-y-1">
                        <p class="text-lg font-semibold text-pink-900">Mês Atual: <span id="total-revenue-current">R$ 0,00</span></p>
                        <p class="text-md text-gray-600">Mês Anterior: <span id="total-revenue-previous">R$ 0,00</span></p>
                    </div>
                </div>
                <div class="bg-green-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-green-700">Projeção da Equipe</p>
                    <p id="projected-team-revenue" class="mt-1 text-2xl font-bold text-green-900">R$ 0,00</p>
                </div>
            </div>

            <hr class="my-6">

            <!-- Gráfico de Vendas Diárias -->
            <div class="mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Vendas Diárias por Produto</h2>
                    <div>
                        <label for="product-filter-select" class="text-sm font-medium text-gray-700 mr-2">Filtrar por Produto:</label>
                        <select id="product-filter-select" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <canvas id="daily-sales-chart" class="h-72"></canvas>
                </div>
            </div>

            <hr class="my-6">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                 <div class="w-full">
                    <h2 class="text-xl font-semibold mb-4">Evolução Coletiva (Últimos 6 Meses)</h2>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <canvas id="collective-sales-chart"></canvas>
                    </div>
                </div>
                <div class="w-full">
                    <h2 class="text-xl font-semibold mb-4">Produtos Vendidos (Total do Mês Atual)</h2>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <canvas id="products-sold-chart" class="h-64"></canvas>
                    </div>
                </div>
            </div>

            <hr class="my-6">

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Desempenho Individual de Consultores</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-4 rounded-tl-lg">Consultor</th>
                                <th class="p-4">Total de Vendas</th>
                                <th class="p-4">Receita Total</th>
                                <th class="p-4">Projeção (Próx. Mês)</th>
                                <th class="p-4 rounded-tr-lg">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="consultants-performance-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Nova seção para Vendas de Produtos -->
        <div id="product-sales-content" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Vendas de Produtos por Mês</h2>
                <button id="back-to-dashboard-from-products-btn" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700">Voltar</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Produto</th>
                            <th class="p-4 text-center">Vendas Mês Atual</th>
                            <th class="p-4 text-center rounded-tr-lg">Vendas Mês Anterior</th>
                        </tr>
                    </thead>
                    <tbody id="product-sales-table-body">
                        <!-- Conteúdo preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Conteúdo de Gestão de Metas (inalterado) -->
        <div id="goals-content" class="hidden">
            <p class="text-gray-500 mb-6">Gerencie as metas mensais para os consultores.</p>
            <div class="mb-4 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="w-full sm:w-1/2">
                    <label for="goals-month" class="block text-sm font-medium text-gray-700">Mês</label>
                    <select id="goals-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </select>
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="goals-year" class="block text-sm font-medium text-gray-700">Ano</label>
                    <select id="goals-year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </select>
                </div>
            </div>
            <table class="min-w-full text-left border-collapse mb-6">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-4 rounded-tl-lg">Produto</th>
                        <th class="p-4">Meta</th>
                        <th class="p-4">Efetivado</th>
                        <th class="p-4 rounded-tr-lg">Falta</th>
                    </tr>
                </thead>
                <tbody id="goals-table-body">
                </tbody>
            </table>
            <button id="save-goals-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Salvar Metas
            </button>
            <div id="goals-message" class="hidden p-4 mt-4 text-sm rounded-lg" role="alert"></div>
        </div>
    </div>
    
    <!-- Seção de Visão de Consultor (inalterada) -->
    <div id="consultant-view-section" class="container hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
            <h1 id="consultant-view-title" class="text-2xl sm:text-3xl font-bold text-gray-800"></h1>
            <button id="back-to-dashboard-btn" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700">Voltar</button>
        </div>
        <div>
            <h2 class="text-xl font-semibold mb-4">Seu Desempenho</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-indigo-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-indigo-700">Receita Total</p>
                    <p id="individual-total-revenue" class="mt-1 text-2xl font-bold text-indigo-900">R$ 0,00</p>
                </div>
                <div class="bg-purple-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-purple-700">Comissão Estimada</p>
                    <p id="individual-estimated-commission" class="mt-1 text-2xl font-bold text-purple-900">R$ 0,00</p>
                </div>
                <div class="bg-pink-50 p-5 rounded-lg shadow-sm">
                    <p id="individual-current-tier-text" class="text-sm font-medium text-pink-700">Sua Faixa Atual</p>
                    <p id="individual-current-tier" class="mt-1 text-2xl font-bold text-pink-900">Faixa 0</p>
                </div>
            </div>
            <div class="mt-6">
                <h3 id="individual-progress-text" class="text-lg font-medium text-gray-700 mb-2"></h3>
                <div class="progress-bar">
                    <div id="individual-progress-fill" class="progress-fill bg-blue-500" style="width: 0%;"></div>
                </div>
            </div>
        </div>
        <hr class="my-6">
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Detalhes da Comissão</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Item</th>
                            <th class="p-4">Valor</th>
                            <th class="p-4 rounded-tr-lg">Faixa de Comissão</th>
                        </tr>
                    </thead>
                    <tbody id="individual-commission-details-body">
                    </tbody>
                </table>
            </div>
        </div>
        <hr class="my-6">
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">Metas de Receita</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Meta</th>
                            <th class="p-4 rounded-tr-lg">Status</th>
                        </tr>
                    </thead>
                    <tbody id="individual-revenue-goals-body">
                    </tbody>
                </table>
            </div>
        </div>
        <hr class="my-6">
        <div>
            <h3 class="text-lg font-semibold mb-4">Metas de Produto por Faixa</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Produto</th>
                            <th class="p-4">Vendido</th>
                            <th class="p-4">Meta Faixa 75</th>
                            <th class="p-4">Meta Faixa 150</th>
                            <th class="p-4 rounded-tr-lg">Meta Faixa 200</th>
                        </tr>
                    </thead>
                    <tbody id="individual-product-goals-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Configuração Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyC293ALvoMmnm6ygd-t9FecegMjln9lEkc",
            authDomain: "calculadora-de-vendas.firebaseapp.com",
            projectId: "calculadora-de-vendas",
            storageBucket: "calculadora-de-vendas.firebasestorage.app",
            messagingSenderId: "633108525289",
            appId: "1:633108525289:web:0b4147c2aa71e637aa4078"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth, managerId;
        
        // --- Elementos DOM ---
        const authSection = document.getElementById('auth-section');
        const mainSection = document.getElementById('main-section');
        const dashboardContent = document.getElementById('dashboard-content');
        const goalsContent = document.getElementById('goals-content');
        const consultantViewSection = document.getElementById('consultant-view-section');
        const productSalesContent = document.getElementById('product-sales-content');

        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authMessageEl = document.getElementById('auth-message');
        const logoutBtn = document.getElementById('logout-btn');
        const consultantsPerformanceBody = document.getElementById('consultants-performance-body');
        const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
        const consultantViewTitleEl = document.getElementById('consultant-view-title');
        const dashboardTabBtn = document.getElementById('dashboard-tab-btn');
        const goalsTabBtn = document.getElementById('goals-tab-btn');
        const mainTitle = document.getElementById('main-title');
        const viewProductsBtn = document.getElementById('view-products-btn');
        const backToDashboardFromProductsBtn = document.getElementById('back-to-dashboard-from-products-btn');
        
        // Elementos dos Cards
        const totalSalesCurrentEl = document.getElementById('total-sales-current');
        const totalSalesPreviousEl = document.getElementById('total-sales-previous');
        const totalRevenueCurrentEl = document.getElementById('total-revenue-current');
        const totalRevenuePreviousEl = document.getElementById('total-revenue-previous');
        const projectedTeamRevenueEl = document.getElementById('projected-team-revenue');
        
        // Elementos da Tabela de Vendas de Produtos
        const productSalesTableBody = document.getElementById('product-sales-table-body');

        // Elementos do Gráfico de Vendas Diárias
        const productFilterSelect = document.getElementById('product-filter-select');

        // --- Gráficos e Dados ---
        let collectiveChart, productsSoldChart, dailySalesChart;
        let allSalesData = [];
        let allConsultantsData = [];
        const currentGoals = {};
        const productList = ['Migração Up', 'Migração Mid', 'Migração Down', 'GPON', 'Altas Portadas', 'Altas Novas', 'VVN', 'Avançados', 'Produtos de TI', 'Aparelhos (R$)'];
        const productCategories = ['Migração', 'GPON', 'Altas Portadas', 'Altas Novas', 'VVN', 'Avançados', 'Produtos de TI', 'Aparelhos (R$)'];


        // --- DADOS DE REGRA DE NEGÓCIO (Inalterados) ---
        const commissionData = { 'Migração Up': [8, 8, 9, 10, 11, 12, 13, 14], 'Migração Mid': [4, 4, 5, 7, 7, 8, 9, 10], 'Migração Down': [2, 2, 3, 4, 5, 6, 7, 8], 'GPON': [20, 22, 25, 28, 31, 35, 40], 'Altas Portadas': [6, 8, 10, 12, 14, 16, 20], 'Altas Novas': [3, 4, 5, 6, 7, 8, 10], 'VVN': [10, 12, 14, 16, 18, 20, 22], 'Avançados': [15, 17, 19, 21, 23, 25, 28], 'Produtos de TI': [10, 11, 12, 13, 14, 15, 16],};
        const revenuePercentages = [11, 13, 16, 19, 22, 28, 35];
        const goalData = { 'Receita (R$)': [750, 1500, 3000], 'GPON': [3, 6, 9], 'Altas Portadas': [5, 15, 30], 'Altas Novas': [5, 15, 30], 'Contratos (CNPJ\'s)': [1, 1.5, 2], 'VVN': [5, 15, 25], 'Aparelhos (R$)': [8000, 20000, 30000], 'Migração': [75, 150, 200], };
        const productsForGoals = ['Migração', 'GPON', 'Altas Portadas', 'Altas Novas', 'VVN', 'Aparelhos (R$)'];
        const goalProductsList = ['Migração', 'GPON', 'Altas Portadas', 'Altas Novas', 'VVN', 'Avançados', 'Produtos de TI'];
        
        // --- FUNÇÕES DE LÓGICA ---
        
        // Função auxiliar para obter as datas do mês atual e anterior
        function getMonthDateRanges() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            const currentMonthStart = new Date(currentYear, currentMonth, 1);
            const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0, 23, 59, 59);

            const previousMonth = new Date(currentYear, currentMonth, 0);
            const previousMonthYear = previousMonth.getFullYear();
            const previousMonthIndex = previousMonth.getMonth();

            const previousMonthStart = new Date(previousMonthYear, previousMonthIndex, 1);
            const previousMonthEnd = new Date(previousMonthYear, previousMonthIndex + 1, 0, 23, 59, 59);

            return { currentMonthStart, currentMonthEnd, previousMonthStart, previousMonthEnd };
        }

        // Função para calcular estatísticas mensais
        function calculateMonthlyStats(sales, startDate, endDate) {
            let totalSales = 0;
            let totalRevenue = 0;
            const productQuantities = {};
            productCategories.forEach(p => productQuantities[p] = 0);

            const filteredSales = sales.filter(sale => {
                if (!sale.timestamp || !sale.timestamp.seconds) return false;
                const saleDate = new Date(sale.timestamp.seconds * 1000);
                return saleDate >= startDate && saleDate <= endDate;
            });

            totalSales = filteredSales.length;

            filteredSales.forEach(sale => {
                totalRevenue += sale.totalRevenue || 0;
                try {
                    const saleProducts = JSON.parse(sale.products);
                    saleProducts.forEach(p => {
                        const quantity = p.quantity || 0;
                        if (p.name.includes('Migração')) {
                            productQuantities['Migração'] += quantity;
                        } else if (productQuantities.hasOwnProperty(p.name)) {
                            productQuantities[p.name] += quantity;
                        }
                    });
                } catch (e) {
                    // Ignora erros de parsing
                }
            });

            return { totalSales, totalRevenue, productQuantities };
        }
        
        function updateDashboardUI(sales, consultants) {
            const { currentMonthStart, currentMonthEnd, previousMonthStart, previousMonthEnd } = getMonthDateRanges();

            // Calcular estatísticas
            const currentMonthStats = calculateMonthlyStats(sales, currentMonthStart, currentMonthEnd);
            const previousMonthStats = calculateMonthlyStats(sales, previousMonthStart, previousMonthEnd);

            // Atualizar Cards
            totalSalesCurrentEl.textContent = currentMonthStats.totalSales;
            totalSalesPreviousEl.textContent = previousMonthStats.totalSales;
            totalRevenueCurrentEl.textContent = `R$ ${currentMonthStats.totalRevenue.toFixed(2).replace('.', ',')}`;
            totalRevenuePreviousEl.textContent = `R$ ${previousMonthStats.totalRevenue.toFixed(2).replace('.', ',')}`;
            
            // Renderizar Gráficos
            renderCollectiveChart(sales);
            renderProductsSoldChart(currentMonthStats.productQuantities);
            renderDailyProductChart(sales); // Renderiza o gráfico diário com o produto selecionado
            
            // Renderizar Tabela de Produtos (para a outra tela)
            renderProductSalesTable(currentMonthStats.productQuantities, previousMonthStats.productQuantities);

            // Lógicas existentes
            calculateAndDisplayProjections(sales, consultants);
            renderConsultantsPerformance(sales, consultants);
        }

        function populateProductFilter() {
            productFilterSelect.innerHTML = ''; // Limpa opções existentes
            productCategories.forEach(product => {
                const option = document.createElement('option');
                option.value = product;
                option.textContent = product;
                productFilterSelect.appendChild(option);
            });
        }
        
        function renderDailyProductChart(sales) {
            const selectedProduct = productFilterSelect.value;
            if (!selectedProduct) return;

            const { currentMonthStart, currentMonthEnd, previousMonthStart, previousMonthEnd } = getMonthDateRanges();

            const numDaysCurrent = currentMonthEnd.getDate();
            const numDaysPrevious = previousMonthEnd.getDate();
            const labels = Array.from({ length: 31 }, (_, i) => i + 1);

            const currentMonthData = new Array(31).fill(0);
            const previousMonthData = new Array(31).fill(0);

            sales.forEach(sale => {
                const saleDate = new Date(sale.timestamp.seconds * 1000);
                const day = saleDate.getDate() - 1; // index 0-30

                let isCurrentMonth = saleDate >= currentMonthStart && saleDate <= currentMonthEnd;
                let isPreviousMonth = saleDate >= previousMonthStart && saleDate <= previousMonthEnd;

                if (isCurrentMonth || isPreviousMonth) {
                     try {
                        const saleProducts = JSON.parse(sale.products);
                        saleProducts.forEach(p => {
                            let productName = p.name;
                            if(productName.includes('Migração')) productName = 'Migração';

                            if (productName === selectedProduct) {
                                if (isCurrentMonth) currentMonthData[day] += p.quantity || 0;
                                if (isPreviousMonth) previousMonthData[day] += p.quantity || 0;
                            }
                        });
                    } catch (e) { /* ignora */ }
                }
            });
            
            if (dailySalesChart) {
                dailySalesChart.destroy();
            }

            const ctx = document.getElementById('daily-sales-chart').getContext('2d');
            dailySalesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `Vendas Mês Atual (${selectedProduct})`,
                            data: currentMonthData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: `Vendas Mês Anterior (${selectedProduct})`,
                            data: previousMonthData,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: false },
                        y: { beginAtZero: true, stacked: false, title: { display: true, text: 'Quantidade Vendida' } }
                    }
                }
            });
        }

        function renderProductSalesTable(currentMonthProducts, previousMonthProducts) {
            productSalesTableBody.innerHTML = '';
            productCategories.forEach(product => {
                const row = document.createElement('tr');
                row.className = "border-t border-gray-200";
                row.innerHTML = `
                    <td class="p-4 font-medium">${product}</td>
                    <td class="p-4 text-center">${currentMonthProducts[product] || 0}</td>
                    <td class="p-4 text-center">${previousMonthProducts[product] || 0}</td>
                `;
                productSalesTableBody.appendChild(row);
            });
        }
        
        function renderProductsSoldChart(productQuantities) {
            const productNames = Object.keys(productQuantities);
            const quantities = Object.values(productQuantities);

            if (productsSoldChart) {
                productsSoldChart.destroy();
            }

            const ctx = document.getElementById('products-sold-chart').getContext('2d');
            productsSoldChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: productNames,
                    datasets: [{
                        label: 'Quantidade Vendida',
                        data: quantities,
                        backgroundColor: ['rgba(255, 99, 132, 0.6)','rgba(54, 162, 235, 0.6)','rgba(255, 206, 86, 0.6)','rgba(75, 192, 192, 0.6)','rgba(153, 102, 255, 0.6)','rgba(255, 159, 64, 0.6)','rgba(199, 199, 199, 0.6)', 'rgba(40, 167, 69, 0.6)'],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function initializeListeners() {
            // Navegação entre painel principal e vendas de produtos
            viewProductsBtn.addEventListener('click', () => {
                dashboardContent.classList.add('hidden');
                goalsContent.classList.add('hidden');
                productSalesContent.classList.remove('hidden');
                mainTitle.textContent = 'Vendas de Produtos';
            });
            
            backToDashboardFromProductsBtn.addEventListener('click', () => {
                productSalesContent.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                mainTitle.textContent = 'Painel de Gerência';
            });
            
            productFilterSelect.addEventListener('change', () => {
                renderDailyProductChart(allSalesData);
            });
        }
        
        // --- FUNÇÕES INALTERADAS OU COM PEQUENOS AJUSTES ---

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) { throw new Error("Configuração do Firebase ausente."); }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        managerId = user.uid;
                        const isManager = await checkManagerStatus(managerId);
                        if (isManager) {
                            authSection.classList.add('hidden');
                            mainSection.classList.remove('hidden');
                            dashboardContent.classList.remove('hidden');
                            goalsContent.classList.add('hidden');
                            productSalesContent.classList.add('hidden');
                            consultantViewSection.classList.add('hidden');
                            populateProductFilter();
                            listenToSalesAndConsultants();
                            populateGoalsSelectors();
                            loadAndRenderGoals();
                            initializeListeners();
                        } else {
                            await signOut(auth);
                            displayAuthMessage('Acesso negado. Esta conta não é de um gerente.', 'error');
                        }
                    } else {
                        authSection.classList.remove('hidden');
                        mainSection.classList.add('hidden');
                        consultantViewSection.classList.add('hidden');
                    }
                });

                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); }
            } catch (e) {
                console.error("Erro ao inicializar Firebase: ", e);
                displayAuthMessage("Erro ao inicializar o aplicativo. Por favor, tente novamente.", "error");
            }
        }
        
        function listenToSalesAndConsultants() {
            if (!db) return;
            const salesRef = collection(db, `artifacts/${appId}/public/data/sales`);
            onSnapshot(salesRef, (snapshot) => {
                allSalesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardUI(allSalesData, allConsultantsData);
            });

            const consultantsRef = collection(db, `artifacts/${appId}/users`);
            onSnapshot(consultantsRef, (snapshot) => {
                allConsultantsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardUI(allSalesData, allConsultantsData);
            });
        }
        
        // ... (Todas as outras funções como checkManagerStatus, displayAuthMessage, renderConsultantsPerformance, lógica de metas, etc., permanecem as mesmas) ...
        function displayAuthMessage(message, type) { authMessageEl.textContent = message; authMessageEl.className = `p-4 mb-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`; authMessageEl.style.display = 'block'; }
        function displayGoalsMessage(message, type) { goalsMessageEl.textContent = message; goalsMessageEl.className = `p-4 mt-4 text-sm rounded-lg ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`; goalsMessageEl.style.display = 'block'; setTimeout(() => { goalsMessageEl.style.display = 'none'; }, 5000); }
        async function checkManagerStatus(uid) { if (!db) return false; try { const managerRef = doc(db, `artifacts/${appId}/managers`, uid); const docSnap = await getDoc(managerRef); return docSnap.exists(); } catch (e) { console.error("Erro ao verificar status de gerente: ", e); return false; } }
        function getPastMonths(count) { const months = []; const today = new Date(); for (let i = count - 1; i >= 0; i--) { const d = new Date(today.getFullYear(), today.getMonth() - i, 1); months.push(d); } return months; }
        function calculateAndDisplayProjections(sales, consultants) { const months = getPastMonths(6); const teamMonthlyRevenue = months.map(month => { return sales.reduce((sum, sale) => { const saleDate = sale.timestamp ? new Date(sale.timestamp.seconds * 1000) : null; if (saleDate && saleDate.getMonth() === month.getMonth() && saleDate.getFullYear() === month.getFullYear()) { return sum + (sale.totalRevenue || 0); } return sum; }, 0); }); let totalGrowth = 0; let countGrowth = 0; for (let i = 1; i < teamMonthlyRevenue.length; i++) { if (teamMonthlyRevenue[i-1] > 0) { const growthRate = (teamMonthlyRevenue[i] - teamMonthlyRevenue[i-1]) / teamMonthlyRevenue[i-1]; totalGrowth += growthRate; countGrowth++; } } const averageGrowth = countGrowth > 0 ? totalGrowth / countGrowth : 0; const lastMonthRevenue = teamMonthlyRevenue[teamMonthlyRevenue.length - 1]; const projectedTeamRevenue = lastMonthRevenue * (1 + averageGrowth); projectedTeamRevenueEl.textContent = `R$ ${projectedTeamRevenue.toFixed(2).replace('.', ',')}`; }
        function renderCollectiveChart(sales) { const months = getPastMonths(6); const monthlyRevenue = months.map(month => { return sales.reduce((sum, sale) => { const saleDate = sale.timestamp ? new Date(sale.timestamp.seconds * 1000) : null; if (saleDate && saleDate.getMonth() === month.getMonth() && saleDate.getFullYear() === month.getFullYear()) { return sum + (sale.totalRevenue || 0); } return sum; }, 0); }); if (collectiveChart) { collectiveChart.destroy(); } const ctx = document.getElementById('collective-sales-chart').getContext('2d'); collectiveChart = new Chart(ctx, { type: 'bar', data: { labels: months.map(m => m.toLocaleString('pt-BR', { month: 'short', year: 'numeric' })), datasets: [{ label: 'Receita Total da Equipe (R$)', data: monthlyRevenue, backgroundColor: 'rgba(75, 192, 192, 0.6)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Receita (R$)' } } } } }); }
        function renderConsultantsPerformance(sales, consultants) { const performanceMap = {}; consultants.forEach(c => { performanceMap[c.id] = { name: c.consultantName || 'Consultor sem nome', salesCount: 0, totalRevenue: 0 }; }); sales.forEach(sale => { if (sale.consultantId && performanceMap[sale.consultantId]) { performanceMap[sale.consultantId].salesCount++; performanceMap[sale.consultantId].totalRevenue += sale.totalRevenue || 0; } }); const sortedConsultants = Object.keys(performanceMap).sort((a, b) => performanceMap[b].totalRevenue - performanceMap[a].totalRevenue); consultantsPerformanceBody.innerHTML = ''; sortedConsultants.forEach(id => { const data = performanceMap[id]; const row = document.createElement('tr'); row.className = "border-t border-gray-200"; row.innerHTML = `<td class="p-4">${data.name}</td><td class="p-4 text-center">${data.salesCount}</td><td class="p-4">R$ ${data.totalRevenue.toFixed(2).replace('.', ',')}</td><td class="p-4">R$ 0,00</td><td class="p-4"><button class="view-details-btn text-blue-500 hover:text-blue-700" data-consultant-id="${id}" data-consultant-name="${data.name}">Ver Visão</button></td>`; consultantsPerformanceBody.appendChild(row); }); document.querySelectorAll('.view-details-btn').forEach(button => { button.addEventListener('click', (e) => { const consultantId = e.target.getAttribute('data-consultant-id'); const consultantName = e.target.getAttribute('data-consultant-name'); renderConsultantView(consultantId, consultantName, sales); }); }); }
        function populateGoalsSelectors() { const today = new Date(); const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro']; goalsMonthSelect.innerHTML = ''; months.forEach((month, index) => { const option = document.createElement('option'); option.value = index + 1; option.textContent = month; if (index === today.getMonth()) { option.selected = true; } goalsMonthSelect.appendChild(option); }); const currentYear = today.getFullYear(); goalsYearSelect.innerHTML = ''; for (let i = 0; i < 5; i++) { const year = currentYear + i; const option = document.createElement('option'); option.value = year; option.textContent = year; if (i === 0) { option.selected = true; } goalsYearSelect.appendChild(option); } }
        async function loadAndRenderGoals() { if (!managerId) return; const month = parseInt(goalsMonthSelect.value); const year = parseInt(goalsYearSelect.value); const goalDocId = `${year}-${month}`; let salesSummary = {}; const salesInPeriod = allSalesData.filter(sale => { const saleDate = sale.timestamp ? new Date(sale.timestamp.seconds * 1000) : null; return saleDate && saleDate.getMonth() + 1 === month && saleDate.getFullYear() === year; }); salesInPeriod.forEach(sale => { try { const saleProducts = JSON.parse(sale.products); saleProducts.forEach(p => { const productName = p.name || 'Desconhecido'; const quantity = p.quantity || 0; if (productName.includes('Migração')) { salesSummary['Migração'] = (salesSummary['Migração'] || 0) + quantity; } else { salesSummary[productName] = (salesSummary[productName] || 0) + quantity; } }); } catch (e) { /*ignora*/ } }); try { const goalsRef = doc(db, `artifacts/${appId}/managers/${managerId}/manager_goals`, goalDocId); const goalsSnap = await getDoc(goalsRef); if (goalsSnap.exists()) { Object.assign(currentGoals, goalsSnap.data().goals); } else { Object.keys(currentGoals).forEach(key => delete currentGoals[key]); } } catch (e) { console.error("Erro ao carregar metas:", e); displayGoalsMessage("Erro ao carregar as metas.", "error"); } renderGoalsTable(salesSummary); }
        function renderGoalsTable(salesSummary) { goalsTableBody.innerHTML = ''; goalProductsList.forEach(product => { const currentGoal = currentGoals[product] || 0; const effective = salesSummary[product] || 0; const missing = Math.max(0, currentGoal - effective); const row = document.createElement('tr'); row.className = "border-t border-gray-200"; row.innerHTML = `<td class="p-4">${product}</td><td class="p-4"><input type="number" data-product="${product}" value="${currentGoal}" min="0" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></td><td class="p-4 text-center">${effective}</td><td class="p-4 text-center">${missing}</td>`; goalsTableBody.appendChild(row); }); }
        async function saveGoals() { if (!managerId) return; const month = goalsMonthSelect.value; const year = goalsYearSelect.value; const goalDocId = `${year}-${month}`; const inputs = goalsTableBody.querySelectorAll('input'); const newGoals = {}; inputs.forEach(input => { const product = input.getAttribute('data-product'); newGoals[product] = parseInt(input.value, 10) || 0; }); try { const goalsRef = doc(db, `artifacts/${appId}/managers/${managerId}/manager_goals`, goalDocId); await setDoc(goalsRef, { goals: newGoals }); displayGoalsMessage("Metas salvas com sucesso!", "success"); } catch (e) { console.error("Erro ao salvar metas:", e); displayGoalsMessage("Erro ao salvar as metas.", "error"); } }
        authForm.addEventListener('submit', async (e) => { e.preventDefault(); const email = authEmailInput.value; const password = authPasswordInput.value; authMessageEl.style.display = 'none'; try { await signInWithEmailAndPassword(auth, email, password); } catch (e) { console.error("Erro de autenticação: ", e.message); displayAuthMessage('Falha no login. Verifique suas credenciais.', 'error'); } });
        logoutBtn.addEventListener('click', async () => { await signOut(auth); });
        backToDashboardBtn.addEventListener('click', () => { consultantViewSection.classList.add('hidden'); mainSection.classList.remove('hidden'); });
        dashboardTabBtn.addEventListener('click', () => { dashboardContent.classList.remove('hidden'); goalsContent.classList.add('hidden'); productSalesContent.classList.add('hidden'); dashboardTabBtn.classList.remove('bg-gray-200', 'text-gray-800'); dashboardTabBtn.classList.add('bg-blue-600', 'text-white'); goalsTabBtn.classList.remove('bg-blue-600', 'text-white'); goalsTabBtn.classList.add('bg-gray-200', 'text-gray-800'); mainTitle.textContent = 'Painel de Gerência'; });
        goalsTabBtn.addEventListener('click', () => { goalsContent.classList.remove('hidden'); dashboardContent.classList.add('hidden'); productSalesContent.classList.add('hidden'); goalsTabBtn.classList.remove('bg-gray-200', 'text-gray-800'); goalsTabBtn.classList.add('bg-blue-600', 'text-white'); dashboardTabBtn.classList.remove('bg-blue-600', 'text-white'); dashboardTabBtn.classList.add('bg-gray-200', 'text-gray-800'); mainTitle.textContent = 'Gestão de Metas'; loadAndRenderGoals(); });
        goalsMonthSelect.addEventListener('change', loadAndRenderGoals); goalsYearSelect.addEventListener('change', loadAndRenderGoals); saveGoalsBtn.addEventListener('click', saveGoals);
        function renderConsultantView(consultantId, consultantName, allSales){/*Lógica inalterada*/}
        
        window.onload = initializeFirebase;
    </script>
</body>
</html>
