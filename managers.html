<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão de Vendas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: 1.5rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .progress-bar {
            height: 1.5rem;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="auth-section" class="container w-full max-w-md p-6 bg-white rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Acesso de Gerência</h2>
        <div id="auth-message" class="hidden p-4 mb-4 text-sm rounded-lg" role="alert"></div>
        <form id="auth-form" class="space-y-4">
            <div>
                <label for="auth-email" class="block text-sm font-medium text-gray-700">E-mail</label>
                <input type="email" id="auth-email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="auth-password" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="auth-password" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            </div>
            <button type="submit" id="auth-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Entrar como Gerente
            </button>
        </form>
    </div>

    <div id="main-section" class="container hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
            <h1 id="main-title" class="text-2xl sm:text-3xl font-bold text-gray-800">Painel de Gerência</h1>
            <div class="flex space-x-2">
                <button id="dashboard-tab-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700">Painel</button>
                <button id="goals-tab-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg shadow-md hover:bg-gray-300">Metas</button>
                <button id="logout-btn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg shadow-md hover:bg-red-700">Sair</button>
            </div>
        </div>
        
        <!-- Conteúdo do Painel -->
        <div id="dashboard-content">
            <div class="flex justify-between items-center mb-6">
                <p class="text-gray-500">Visão consolidada da performance da equipe.</p>
                <button id="view-products-btn" class="px-4 py-2 bg-teal-600 text-white font-medium rounded-lg shadow-md hover:bg-teal-700">Ver Vendas de Produtos</button>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Cards de Vendas e Receita atualizados -->
                <div class="bg-purple-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-purple-700">Total de Vendas</p>
                    <div class="mt-2 space-y-1">
                        <p class="text-lg font-semibold text-purple-900">Mês Atual: <span id="total-sales-current">0</span></p>
                        <p class="text-md text-gray-600">Mês Anterior: <span id="total-sales-previous">0</span></p>
                    </div>
                </div>
                <div class="bg-pink-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-pink-700">Receita Total da Equipe</p>
                    <div class="mt-2 space-y-1">
                        <p class="text-lg font-semibold text-pink-900">Mês Atual: <span id="total-revenue-current">R$ 0,00</span></p>
                        <p class="text-md text-gray-600">Mês Anterior: <span id="total-revenue-previous">R$ 0,00</span></p>
                    </div>
                </div>
                <div class="bg-green-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-green-700">Projeção da Equipe</p>
                    <p id="projected-team-revenue" class="mt-1 text-2xl font-bold text-green-900">R$ 0,00</p>
                </div>
            </div>

            <hr class="my-6">

            <!-- Gráfico de Vendas Diárias -->
            <div class="mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Vendas Diárias por Produto</h2>
                    <div>
                        <label for="product-filter-select" class="text-sm font-medium text-gray-700 mr-2">Filtrar por Produto:</label>
                        <select id="product-filter-select" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></select>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <canvas id="daily-sales-chart" class="h-72"></canvas>
                </div>
            </div>

            <hr class="my-6">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                 <div class="w-full">
                    <h2 class="text-xl font-semibold mb-4">Evolução Coletiva (Últimos 6 Meses)</h2>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <canvas id="collective-sales-chart"></canvas>
                    </div>
                </div>
                <div class="w-full">
                    <h2 class="text-xl font-semibold mb-4">Produtos Vendidos (Total do Mês Atual)</h2>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <canvas id="products-sold-chart" class="h-64"></canvas>
                    </div>
                </div>
            </div>

            <hr class="my-6">

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Desempenho Individual de Consultores</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-4 rounded-tl-lg">Consultor</th>
                                <th class="p-4">Total de Vendas</th>
                                <th class="p-4">Receita Total</th>
                                <th class="p-4">Projeção (Próx. Mês)</th>
                                <th class="p-4 rounded-tr-lg">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="consultants-performance-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Nova seção para Vendas de Produtos -->
        <div id="product-sales-content" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Vendas de Produtos por Mês</h2>
                <button id="back-to-dashboard-from-products-btn" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700">Voltar</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Produto</th>
                            <th class="p-4 text-center">Vendas Mês Atual</th>
                            <th class="p-4 text-center rounded-tr-lg">Vendas Mês Anterior</th>
                        </tr>
                    </thead>
                    <tbody id="product-sales-table-body">
                        <!-- Conteúdo preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Conteúdo de Gestão de Metas (inalterado) -->
        <div id="goals-content" class="hidden">
            <p class="text-gray-500 mb-6">Gerencie as metas mensais para os consultores.</p>
            <div class="mb-4 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <div class="w-full sm:w-1/2">
                    <label for="goals-month" class="block text-sm font-medium text-gray-700">Mês</label>
                    <select id="goals-month" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </select>
                </div>
                <div class="w-full sm:w-1/2">
                    <label for="goals-year" class="block text-sm font-medium text-gray-700">Ano</label>
                    <select id="goals-year" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </select>
                </div>
            </div>
            <table class="min-w-full text-left border-collapse mb-6">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-4 rounded-tl-lg">Produto</th>
                        <th class="p-4">Meta</th>
                        <th class="p-4">Efetivado</th>
                        <th class="p-4 rounded-tr-lg">Falta</th>
                    </tr>
                </thead>
                <tbody id="goals-table-body">
                </tbody>
            </table>
            <button id="save-goals-btn" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white font-medium rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Salvar Metas
            </button>
            <div id="goals-message" class="hidden p-4 mt-4 text-sm rounded-lg" role="alert"></div>
        </div>
    </div>
    
    <!-- Seção de Visão de Consultor (inalterada) -->
    <div id="consultant-view-section" class="container hidden">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
            <h1 id="consultant-view-title" class="text-2xl sm:text-3xl font-bold text-gray-800"></h1>
            <button id="back-to-dashboard-btn" class="px-4 py-2 bg-gray-600 text-white font-medium rounded-lg shadow-md hover:bg-gray-700">Voltar</button>
        </div>
        <div>
            <h2 class="text-xl font-semibold mb-4">Seu Desempenho</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-indigo-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-indigo-700">Receita Total</p>
                    <p id="individual-total-revenue" class="mt-1 text-2xl font-bold text-indigo-900">R$ 0,00</p>
                </div>
                <div class="bg-purple-50 p-5 rounded-lg shadow-sm">
                    <p class="text-sm font-medium text-purple-700">Comissão Estimada</p>
                    <p id="individual-estimated-commission" class="mt-1 text-2xl font-bold text-purple-900">R$ 0,00</p>
                </div>
                <div class="bg-pink-50 p-5 rounded-lg shadow-sm">
                    <p id="individual-current-tier-text" class="text-sm font-medium text-pink-700">Sua Faixa Atual</p>
                    <p id="individual-current-tier" class="mt-1 text-2xl font-bold text-pink-900">Faixa 0</p>
                </div>
            </div>
            <div class="mt-6">
                <h3 id="individual-progress-text" class="text-lg font-medium text-gray-700 mb-2"></h3>
                <div class="progress-bar">
                    <div id="individual-progress-fill" class="progress-fill bg-blue-500" style="width: 0%;"></div>
                </div>
            </div>
        </div>
        <hr class="my-6">
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4">Detalhes da Comissão</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Item</th>
                            <th class="p-4">Valor</th>
                            <th class="p-4 rounded-tr-lg">Faixa de Comissão</th>
                        </tr>
                    </thead>
                    <tbody id="individual-commission-details-body">
                    </tbody>
                </table>
            </div>
        </div>
        <hr class="my-6">
        <div class="mb-6">
            <h3 class="text-lg font-semibold mb-4">Metas de Receita</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Meta</th>
                            <th class="p-4 rounded-tr-lg">Status</th>
                        </tr>
                    </thead>
                    <tbody id="individual-revenue-goals-body">
                    </tbody>
                </table>
            </div>
        </div>
        <hr class="my-6">
        <div>
            <h3 class="text-lg font-semibold mb-4">Metas de Produto por Faixa</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200">
                            <th class="p-4 rounded-tl-lg">Produto</th>
                            <th class="p-4">Vendido</th>
                            <th class="p-4">Meta Faixa 75</th>
                            <th class="p-4">Meta Faixa 150</th>
                            <th class="p-4 rounded-tr-lg">Meta Faixa 200</th>
                        </tr>
                    </thead>
                    <tbody id="individual-product-goals-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
// ... existing code ... -->
        const mainTitle = document.getElementById('main-title');
        const viewProductsBtn = document.getElementById('view-products-btn');
        const backToDashboardFromProductsBtn = document.getElementById('back-to-dashboard-from-products-btn');
        
        // Elementos dos Cards
        const totalSalesCurrentEl = document.getElementById('total-sales-current');
// ... existing code ... -->
        const productSalesTableBody = document.getElementById('product-sales-table-body');

        // Elementos do Gráfico de Vendas Diárias
        const productFilterSelect = document.getElementById('product-filter-select');

        // Elementos da Visão do Consultor
        const individualTotalRevenueEl = document.getElementById('individual-total-revenue');
        const individualEstimatedCommissionEl = document.getElementById('individual-estimated-commission');
        const individualCurrentTierEl = document.getElementById('individual-current-tier');
        const individualProgressTextEl = document.getElementById('individual-progress-text');
        const individualProgressFillEl = document.getElementById('individual-progress-fill');
        const individualCommissionDetailsBodyEl = document.getElementById('individual-commission-details-body');
        const individualRevenueGoalsBodyEl = document.getElementById('individual-revenue-goals-body');
        const individualProductGoalsBodyEl = document.getElementById('individual-product-goals-body');

        // Elementos de Metas
        const goalsMonthSelect = document.getElementById('goals-month');
        const goalsYearSelect = document.getElementById('goals-year');
        const goalsTableBody = document.getElementById('goals-table-body');
        const saveGoalsBtn = document.getElementById('save-goals-btn');
        const goalsMessageEl = document.getElementById('goals-message');

        // --- Gráficos e Dados ---
        let collectiveChart, productsSoldChart, dailySalesChart;
        let allSalesData = [];
// ... existing code ... -->
        goalsTabBtn.addEventListener('click', () => { goalsContent.classList.remove('hidden'); dashboardContent.classList.add('hidden'); productSalesContent.classList.add('hidden'); goalsTabBtn.classList.remove('bg-gray-200', 'text-gray-800'); goalsTabBtn.classList.add('bg-blue-600', 'text-white'); dashboardTabBtn.classList.remove('bg-blue-600', 'text-white'); dashboardTabBtn.classList.add('bg-gray-200', 'text-gray-800'); mainTitle.textContent = 'Gestão de Metas'; loadAndRenderGoals(); });
        goalsMonthSelect.addEventListener('change', loadAndRenderGoals); goalsYearSelect.addEventListener('change', loadAndRenderGoals); saveGoalsBtn.addEventListener('click', saveGoals);
        
        function renderConsultantView(consultantId, consultantName, allSales) {
            mainSection.classList.add('hidden');
            consultantViewSection.classList.remove('hidden');
            consultantViewTitleEl.textContent = `Visão do Consultor: ${consultantName}`;

            const sales = allSales.filter(sale => sale.consultantId === consultantId);

            let totalRevenue = 0;
            const productsSoldSummary = {};
            let totalMigracaoSold = 0;
            let totalAparelhosSoldValue = 0;

            sales.forEach(sale => {
                try {
                    const saleProducts = JSON.parse(sale.products);
                    saleProducts.forEach(p => {
                        const productNameKey = p.name.includes('Migração') ? 'Migração' : p.name;
                        if (productNameKey in productsSoldSummary) {
                            productsSoldSummary[productNameKey] = (productsSoldSummary[productNameKey] || 0) + (p.quantity || 0);
                        } else {
                            productsSoldSummary[productNameKey] = (p.quantity || 0);
                        }
                        if (['Migração Up', 'Migração Mid', 'Migração Down'].includes(p.name)) {
                            totalMigracaoSold += (p.quantity || 0);
                        }
                        if (p.name === 'Aparelhos (R$)') {
                            totalAparelhosSoldValue += (p.revenue || 0);
                        } else {
                            totalRevenue += (p.revenue || 0);
                        }
                    });
                } catch (e) {
                    console.error("Erro ao analisar JSON de produtos na visão do consultor:", e);
                }
            });

            productsSoldSummary['Migração'] = totalMigracaoSold;
            productsSoldSummary['Aparelhos (R$)'] = totalAparelhosSoldValue;
            totalRevenue += totalAparelhosSoldValue * 0.01;

            let currentTier = 0;
            const revenueGoals = goalData['Receita (R$)'];
            
            if (totalRevenue >= revenueGoals[0]) currentTier++;
            if (totalRevenue >= revenueGoals[1]) currentTier++;
            if (totalRevenue >= revenueGoals[2]) currentTier++;

            productsForGoals.forEach(product => {
                const sold = productsSoldSummary[product] || 0;
                const goals = goalData[product] || [];
                if (goals.length > 0 && sold >= goals[0]) currentTier++;
                if (goals.length > 1 && sold >= goals[1]) currentTier++;
                if (goals.length > 2 && sold >= goals[2]) currentTier++;
            });
            
            let totalCommission = 0;
            const commissionDetails = {};
            
            let tierIndexForCommission = currentTier;
            if (currentTier > 0) tierIndexForCommission = currentTier - 1;
            tierIndexForCommission = Math.min(tierIndexForCommission, commissionData['Migração Mid'].length - 1);

            sales.forEach(sale => {
                const saleProducts = JSON.parse(sale.products);
                saleProducts.forEach(p => {
                    const commissionRate = commissionData[p.name] ? commissionData[p.name][tierIndexForCommission] : 0;
                    const productCommission = (p.quantity || 0) * commissionRate;
                    
                    if (commissionDetails[p.name]) {
                        commissionDetails[p.name].value += productCommission;
                        commissionDetails[p.name].quantity += (p.quantity || 0);
                    } else {
                        commissionDetails[p.name] = {
                            value: productCommission,
                            quantity: (p.quantity || 0),
                            rate: commissionRate
                        };
                    }
                });
            });
            
            const revenueCommission = totalRevenue * (revenuePercentages[tierIndexForCommission] / 100);
            commissionDetails['Receita Total'] = {
                value: revenueCommission,
                rate: revenuePercentages[tierIndexForCommission] + '%'
            };

            totalCommission = Object.values(commissionDetails).reduce((sum, item) => sum + item.value, 0);

            individualTotalRevenueEl.textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
            individualEstimatedCommissionEl.textContent = `R$ ${totalCommission.toFixed(2).replace('.', ',')}`;
            individualCurrentTierEl.textContent = `Faixa ${currentTier}`;
            
            let nextTierGoal = 0;
            let progressPercentage = 0;
            const nextRevenueGoalIndex = revenueGoals.findIndex(goal => totalRevenue < goal);
            
            if (nextRevenueGoalIndex !== -1) {
                nextTierGoal = revenueGoals[nextRevenueGoalIndex];
                progressPercentage = Math.min(100, (totalRevenue / nextTierGoal) * 100);
                individualProgressTextEl.textContent = `Progresso para a Faixa ${currentTier + 1}:`;
            } else {
                progressPercentage = 100;
                individualProgressTextEl.textContent = 'Parabéns! Você alcançou a Faixa mais alta!';
            }
            individualProgressFillEl.style.width = `${progressPercentage}%`;
            individualProgressFillEl.className = `progress-fill ${progressPercentage >= 100 ? 'bg-green-500' : 'bg-blue-500'}`;
            
            renderIndividualCommissionDetails(commissionDetails);
            renderIndividualRevenueGoals(totalRevenue);
            renderIndividualProductGoals(productsSoldSummary);
        }

        function renderIndividualCommissionDetails(details) {
            individualCommissionDetailsBodyEl.innerHTML = '';
            const sortedKeys = Object.keys(details).sort();

            sortedKeys.forEach(key => {
                const detail = details[key];
                const row = document.createElement('tr');
                row.className = "border-t border-gray-200";
                
                let itemName = key;
                if (detail.quantity) {
                    itemName = `${key} (${detail.quantity})`;
                }

                row.innerHTML = `
                    <td class="p-4">${itemName}</td>
                    <td class="p-4">R$ ${detail.value.toFixed(2).replace('.', ',')}</td>
                    <td class="p-4">${detail.rate}</td>
                `;
                individualCommissionDetailsBodyEl.appendChild(row);
            });
        }
        
        function renderIndividualRevenueGoals(totalRevenue) {
            individualRevenueGoalsBodyEl.innerHTML = '';
            const goals = goalData['Receita (R$)'];
            
            goals.forEach(goal => {
                const isMet = totalRevenue >= goal;
                const status = isMet ? 'Atingida' : 'Ainda não';
                const statusClass = isMet ? 'text-green-500' : 'text-gray-500';
                
                const row = document.createElement('tr');
                row.className = "border-t border-gray-200";
                row.innerHTML = `
                    <td class="p-4">R$ ${goal.toFixed(2).replace('.', ',')}</td>
                    <td class="p-4 ${statusClass}">${status}</td>
                `;
                individualRevenueGoalsBodyEl.appendChild(row);
            });
        }

        function renderIndividualProductGoals(productsSoldSummary) {
            individualProductGoalsBodyEl.innerHTML = '';
            
            productsForGoals.forEach(product => {
                const sold = productsSoldSummary[product] || 0;
                const goals = goalData[product] || [0, 0, 0];
                
                const row = document.createElement('tr');
                row.className = "border-t border-gray-200";

                const goal75Met = sold >= goals[0];
                const goal150Met = sold >= goals[1];
                const goal200Met = sold >= goals[2];

                let soldValue = sold;
                if (product === 'Aparelhos (R$)') {
                    soldValue = `R$ ${sold.toFixed(2).replace('.', ',')}`;
                }

                row.innerHTML = `
                    <td class="p-4">${product}</td>
                    <td class="p-4 text-center">${soldValue}</td>
                    <td class="p-4 text-center ${goal75Met ? 'text-green-500 font-bold' : ''}">${product === 'Aparelhos (R$)' ? `R$ ${goals[0].toFixed(2).replace('.', ',')}` : goals[0]}</td>
                    <td class="p-4 text-center ${goal150Met ? 'text-green-500 font-bold' : ''}">${product === 'Aparelhos (R$)' ? `R$ ${goals[1].toFixed(2).replace('.', ',')}` : goals[1]}</td>
                    <td class="p-4 text-center ${goal200Met ? 'text-green-500 font-bold' : ''}">${product === 'Aparelhos (R$)' ? `R$ ${goals[2].toFixed(2).replace('.', ',')}` : goals[2]}</td>
                `;
                individualProductGoalsBodyEl.appendChild(row);
            });
        }
        
        window.onload = initializeFirebase;
    </script>
</body>
</html>

